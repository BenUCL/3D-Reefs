#####################
# for:
/home/ben/encode/code/PyCuSFM/pycusfm/configs/av/vision_mapping_config.pb.txt
#  change:
bundle_adjustment_config {
  ...
  use_cudss_solver: true  <-- CHANGE THIS
  ...
  do_rolling_shutter_correction: true  <-- CHANGE THIS TOO
}

# and:
min_num_matches_per_pair: 15
# to:
min_num_matches_per_pair: 8


# Also in:
/home/ben/encode/code/PyCuSFM/pycusfm/cusfm_runner.py
# Added at line 124:
self.do_rolling_shutter_correction = False ####



#################################
# Okay now trying with all images by interpolating cam positions
# reverted all settings back to defaults except these two invision_mapping_config:
use_cudss_solver: false              # MUST BE FALSE
do_rolling_shutter_correction: false # MUST BE FALSE




#################################
#got 800 points with:
search_translation_threshold_meters: 20
search_rotation_threshold_degrees: 90
max_frame_pair_size_per_file: 100000
min_time_interval_between_keyframes_seconds: 0.5
min_distance_between_keyframes_meters: 0.05
collection_time_interval_seconds: 300
max_keyframes_per_collection: 6

# RADIUS_SEARCH,IMAGE_RETRIEVAL and  TRACK_2D_OVERLAP_IR
# TRACK_2D_OVERLAP_IR select pair by track,
# in-track use time consecutive frames, cross-track use max 2D-overlap frame and verified by image retrieval
search_method: TRACK_2D_OVERLAP_IR
use_downsampling: false

# For IMAGE_RETRIEVAL search method.
query_result_number: 100
min_shared_word_number: 1

# For 2D Fov overlap
far_plane_distance: 50

AND:

min_num_matches_per_pair: 8
depth_threshold: 300
search_depth: 15
min_correspondences: 2
initial_max_pixel_error: 40.0
final_max_pixel_error: 8.0
min_triangulation_deg: 1.0
max_ransac_iteration: 1000
min_num_samples: 3
iterative_triangulation_times: 10
maximum_cache_frame_size: 10000
# use num_threads=1 to get deterministic triangulation results.
num_threads: 12
random_seed: 1

triangulation_method: MIDPOINT

# BA convergence criteria
# For first BA
num_ba_iterations: 5
# For refine BA
max_observation_change: 0.0005

bundle_adjustment_config {
  # TRIVIAL
  # SOFT_L1
  # CAUCHY
  loss_type: CAUCHY
  loss_function_scale: 1.0
  minimizer_progress_to_stdout: true
  max_num_iterations: 200
  max_invalid_steps: 10
  max_linear_solver_iterations: 100
  num_threads: 12
  reprojection_error_standard_deviation: 4.0
  verbose: true

  use_cudss_solver: false

  relative_constraint_use_pose_covariance: false
  do_rolling_shutter_correction: false

  absolute_position_constraint_error_meters: 5
  absolute_pose_translation_error_meters: 1
  absolute_pose_rotation_error_degrees: 5
  relative_pose_translation_error_meters: 1
  relative_pose_rotation_error_degrees: 10
  extrinsic_error_meters: 0.05
  extrinsic_error_degrees: 2

  # frame type for cost
  ba_frame_type: VEHICLE_FRAME
}

# AUTO
# POSITION_CONSTRAINS
# RELATIVE_CONSTRAINS
# CONSTANT_CONSTRAINS
pose_constrains_type: POSITION_CONSTRAINS
extrinsic_max_timestamp_diff_microseconds: 1000 # 1ms

# 0.1s > 3 frames for 30Hz camera
relative_pose_measurement_min_timestamp_gap_us: 100000

use_camera_extrinsic_constraint: true
use_relative_pose_constraint: true
use_absolute_position_constraints: true
use_absolute_pose_constraints: true
localization_mode: FIX

refine_ba: true
image_pair_min_shared_points: 1
refine_ba_use_fixed_max_pixel_error: true
refine_ba_avoid_loss_function: true

# COULD TRY< DID NOT USE
# also for:
/home/ben/encode/code/PyCuSFM/pycusfm/configs/av/match_pair_select_config.pb.txt
# from
min_time_interval_between_keyframes_seconds: 0.5
# to:
min_time_interval_between_keyframes_seconds: 0.001
